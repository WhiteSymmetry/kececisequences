<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Keçeci Sequences: Keçeci Dizileri — Periyot & KPN</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:20px; background:#fafafa; color:#222 }
    .card { max-width:1100px; border:1px solid #e2e2e2; padding:16px; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.03) }
    input[type=number]{ padding:8px; border-radius:6px; border:1px solid #ccc; width:110px; margin-right:8px }
    label { margin-right:12px; font-size:14px }
    button{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; background:#111;color:#fff }
    pre{ background:#f7f7f7; padding:12px; border-radius:8px; white-space:pre-wrap; font-size:13px; overflow:auto; max-height:260px }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px }
    canvas{ margin-top:16px; background:#fff; border-radius:8px; }
    .muted { color:#666; font-size:13px }
  </style>
</head>
<body>
  <div class="card">
    <h2>Keçeci Sequences: Keçeci Dizileri — Periyot &amp; KPN</h2>

    <div class="controls">
      <label>Başlangıç (S₀): <input id="start" type="number" value="0" /></label>
      <label>Artış (A): <input id="inc" type="number" value="9" /></label>
      <label>İterasyon (N): <input id="iters" type="number" value="40" /></label>
      <label><input id="includeInter" type="checkbox" checked /> Ara adımları göster (include_intermediate)</label>
      <label>Kaç adım üretilecek: <input id="steps" type="number" value="200" /></label>
      <label>Periyot arama sınırı: <input id="periodLimit" type="number" value="1000" /></label>
      <button id="runBtn">Üret</button>
      <span class="muted">Not: KPN tespiti periyodik sufiks üzerinden yapılır; periyot bulunamazsa artırma önerisi gelir.</span>
    </div>

    <pre id="out"></pre>
    <canvas id="chart" width="980" height="320"></canvas>
  </div>

  <script>
    // ---------- Yardımcılar ----------
    function isPrime(n) {
      n = Math.floor(Math.abs(Number(n)));
      if (n < 2) return false;
      if (n === 2) return true;
      if (n % 2 === 0) return false;
      const r = Math.floor(Math.sqrt(n));
      for (let i = 3; i <= r; i += 2) if (n % i === 0) return false;
      return true;
    }

    // Keçeci dizisi üretimi (sayısal, Number)
    // Kural: add -> deneme (primary/secondary) -> ASK (±1 dönüşümlü) -> devam
    function generateKececiSequence(start, add, desiredLength) {
      const seq = [];
      let current = Number(start);
      let lastDivisor = null; // 2 veya 3 veya null
      let askSign = 1;
      const ASK_UNIT = 1;

      seq.push(current);

      while (seq.length < desiredLength) {
        const added = current + add;
        seq.push(added);

        const primary = (lastDivisor === 3) ? 2 : 3;
        const secondary = (primary === 2) ? 3 : 2;

        if (added % primary === 0) {
          const v = added / primary;
          seq.push(v);
          current = v;
          lastDivisor = primary;
          continue;
        }
        if (added % secondary === 0) {
          const v = added / secondary;
          seq.push(v);
          current = v;
          lastDivisor = secondary;
          continue;
        }

        if (isPrime(added)) {
          const modified = added + askSign * ASK_UNIT;
          askSign *= -1;
          seq.push(modified); // ASK sonrası
          if (modified % primary === 0) {
            const v = modified / primary;
            seq.push(v);
            current = v;
            lastDivisor = primary;
            continue;
          }
          if (modified % secondary === 0) {
            const v = modified / secondary;
            seq.push(v);
            current = v;
            lastDivisor = secondary;
            continue;
          }
          current = modified;
          continue;
        }

        // Hiçbir koşul değilse doğrudan added ile devam
        current = added;
      }

      // Kes ve dön (sadece numbers)
      return seq.slice(0, desiredLength);
    }

    // ------------- Periyot tespiti (sufiks tipi) --------------
    // Hedef: dizinin bir sufiksinde s başlangıçlı p uzunluğunda bir desen varsa bul.
    // return { start: s, period: p } veya null
    function findPeriodicSuffix(seq, limit) {
      const n = seq.length;
      const maxP = Math.min(limit, Math.floor(n / 2));
      // Öncelik: erken başlayan sufiks (küçük s) ve küçük p
      for (let s = 0; s <= n - 2; s++) {
        // p en az 1 ve en fazla maxP, ancak s + 2*p <= n (en az iki tekrar sığmalı)
        for (let p = 1; p <= maxP && (s + 2 * p) <= n; p++) {
          let ok = true;
          for (let i = s; i < n; i++) {
            const expected = seq[s + ((i - s) % p)];
            if (seq[i] !== expected) { ok = false; break; }
          }
          if (ok) {
            return { start: s, period: p };
          }
        }
      }
      return null;
    }

    // KPN seçim: periyodik sufiksteki (start..end) asal sayıların SUFIKSTEKİ tekrar sayısına göre en çok tekrar eden asal
    // Eşitlikte: sufikste daha önce görüleni seç
    function findKPNFromSuffix(seq, start, period) {
      if (start === null || period === null) return null;
      const freq = new Map();
      const firstIdx = new Map();
      for (let i = start; i < seq.length; i++) {
        const v = Math.floor(Math.abs(Number(seq[i])));
        if (!isPrime(v)) continue;
        freq.set(v, (freq.get(v) || 0) + 1);
        if (!firstIdx.has(v)) firstIdx.set(v, i - start); // sufiks içindeki index
      }
      if (freq.size === 0) return null;
      let best = null, bestCnt = -1, bestPos = Infinity;
      for (const [p, c] of freq.entries()) {
        const pos = firstIdx.get(p);
        if (c > bestCnt || (c === bestCnt && pos < bestPos)) {
          best = p; bestCnt = c; bestPos = pos;
        }
      }
      return best;
    }

    // ---------- Görselleştirme yardımcı ----------
    let chartObj = null;
    function drawChart(seq, periodInfo) {
      const ctx = document.getElementById('chart').getContext('2d');
      if (chartObj) chartObj.destroy();

      // İki dataset: bütün dizi (gri), sufiks periyodik noktalar (renkli)
      const labels = seq.map((_, i) => i);
      const baseData = seq.map(Number);

      // periodic overlay: non-periodic -> null, periodic indices -> value
      let overlay = new Array(seq.length).fill(null);
      if (periodInfo) {
        const s = periodInfo.start;
        for (let i = s; i < seq.length; i++) overlay[i] = seq[i];
      }

      chartObj = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Keçeci Dizisi',
              data: baseData,
              borderColor: '#888',
              backgroundColor: '#ccc',
              fill: false,
              pointRadius: 3,
              borderWidth: 1
            },
            {
              label: 'Periyodik Sufiks',
              data: overlay,
              borderColor: '#d9534f',
              backgroundColor: '#f7b2b0',
              fill: false,
              pointRadius: 4,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { display: true } },
          scales: {
            x: { title: { display: true, text: 'Adım (index)' } },
            y: { title: { display: true, text: 'Değer' } }
          }
        }
      });
    }

    // ---------- Ana koşucu ----------
    async function runOnce() {
      // Değerleri al
      let start = Number(document.getElementById('start').value || 0);
      let inc = Number(document.getElementById('inc').value || 9);
      const iters = Math.max(1, Number(document.getElementById('iters').value || 40));
      const includeInter = document.getElementById('includeInter').checked;
      let steps = Math.max(10, Number(document.getElementById('steps').value || 200));
      let periodLimit = Math.max(1, Number(document.getElementById('periodLimit').value || 1000));

      // Üret ve periyot bulma döngüsü (kullanıcı onayıyla steps veya periodLimit artırılabilir)
      while (true) {
        const seq = generateKececiSequence(start, inc, steps);

        // Periyodu sufiks üzerinden ara
        const periodInfo = findPeriodicSuffix(seq, periodLimit);

        if (periodInfo) {
          // KPN hesapla (periyodik sufiks içindeki en çok tekrar eden asal)
          const kpn = findKPNFromSuffix(seq, periodInfo.start, periodInfo.period);

          // Çıktı metni (ekranda iters kadar göster)
          let out = '';
          if (includeInter) {
            out += 'intermediate calculation steps: Yes\n';
            out += JSON.stringify(seq.slice(0, iters).map(String)) + '\n';
          } else {
            out += 'intermediate calculation steps: No\n';
            out += 'Preview: ' + JSON.stringify(seq.slice(0, Math.min(40, iters)).map(String)) + (iters > 40 ? '...' : '') + '\n';
          }

          out += '\nPeriyot bulundu. (sufiks başlangıcı index = ' + periodInfo.start + ', periyot uzunluğu = ' + periodInfo.period + ')\n';
          out += 'Periyot dizisi: ' + JSON.stringify(seq.slice(periodInfo.start, periodInfo.start + periodInfo.period).map(String)) + '\n';
          out += (kpn !== null) ? ('Keçeci Prime Number found: ' + kpn) : ('Keçeci Prime Number found: None (periyod içinde asal yok)');

          document.getElementById('out').textContent = out;

          drawChart(seq, periodInfo);
          return; // bitti
        } else {
          // Periyot bulunamadı: Kullanıcıya öner
          let msg = 'Periyot bulunamadı. (steps = ' + steps + ', periodLimit = ' + periodLimit + ').\n' +
                    'Periyot araması için daha uzun bir dizi veya daha büyük periyot sınırı gerekebilir.\n\n' +
                    'Adım sayısını (steps) artırmak ister misiniz? (Tamam = artır, İptal = periyot sınırını artır)';
          if (confirm(msg)) {
            // steps'i arttır: en az 2*periodLimit ya da iki katı
            const newSteps = Math.max(steps * 2, periodLimit * 2, steps + 200);
            steps = Math.min(newSteps, 20000); // güvenlik üst sınırı
            document.getElementById('steps').value = steps;
            // döngü devam edecek; tekrar üretilecek
            continue;
          } else {
            // Kullanıcı steps arttırmak istemedi -> periodLimit artırmayı sor
            if (confirm('Periyot sınırını (periodLimit) artırmak ister misiniz? (Tamam = artır, İptal = sonlandır)')) {
              periodLimit = Math.min(periodLimit * 2, 20000);
              document.getElementById('periodLimit').value = periodLimit;
              continue;
            } else {
              // Kullanıcı devam istemiyor — çıktı ver ve grafik çiz üretilebilen dizi ile
              const seqShort = generateKececiSequence(start, inc, Math.max(steps, 100));
              let out = '';
              if (includeInter) {
                out += 'intermediate calculation steps: Yes\n';
                out += JSON.stringify(seqShort.slice(0, iters).map(String)) + '\n';
              } else {
                out += 'intermediate calculation steps: No\n';
                out += 'Preview: ' + JSON.stringify(seqShort.slice(0, Math.min(40, iters)).map(String)) + (iters > 40 ? '...' : '') + '\n';
              }
              out += '\nPeriyot bulunamadı (kullanıcı istediği için arama durduruldu).\n';
              out += 'Denenen steps = ' + steps + ', periodLimit = ' + periodLimit + '.';
              document.getElementById('out').textContent = out;
              drawChart(seqShort, null);
              return;
            }
          }
        }
      } // while
    }

    document.getElementById('runBtn').addEventListener('click', runOnce);

    // İlk otomatik çalıştırma (varsayılanlarla)
    // runOnce(); // otomatik çalıştırmayı istemiyorsanız yorumlayın
  </script>
</body>
</html>
